<!DOCTYPE html5>
<html>
	<head>
		 <meta http-equiv="Pragma" content="no-cache">
		 <meta http-equiv="Cache-Control" content="no-cache">
		 <meta http-equiv="Expires" content="Sat, 01 Dec 2001 00:00:00 GMT">
		<title>Action Painter</title>
		<style>
			body {
				margin: 0;
			}
			#brush {
				-webkit-transition: top 0.1s ease, left 0.1s ease;
				position: absolute;
				width: 64px;
				margin-top: -10px;
				margin-left: -10px;
			}
			#paintCanvas {
				position: absolute;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
			}
		</style>
		<script src="static/socket.io.js"></script>
		<script src="static/base64.js"></script>
		<script src="static/canvas2image.js"></script>
	</head>
	<body>
		<canvas id="paintCanvas" width=1420 height=850></canvas> 

		<div id="brushDiv" style="position:absolute">
			<canvas id="brushCanvas"></canvas>
 		</div>		

		<img id="splash" src="static/splash.png" width="100" style="display:none"/>
		<img id="brush" src="static/brush.png" width="64" style="display:none"/>

		<script type="text/javascript">

var socket = io.connect('/');
	socket.on('orientationupdate', function (data) {
		handle(data);
 	});
 

var brushDiv = document.getElementById("brushDiv");
var paintCanvas = document.getElementById("paintCanvas");
var brushCanvas = document.getElementById("brushCanvas");
var splash = document.getElementById("splash");
var brushCtx = brushCanvas.getContext("2d");
var paintCtx = paintCanvas.getContext("2d");
//canvas.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
//canvas.mozRequestFullScreen();


var vel_x = 0, vel_y = 0, vel_z = 0;
var loc_x = 400, loc_y = 400, loc_z = 0;
var MASS_RATIO = 0.1;
var MAX_VELOCITY = 10;
var BRUSH_SPEED = 10;
var ORIENTATION_FACTOR = 0.5;
var RAD = 57.2957795;
var AMPLITUDE = 7;

paintCtx.moveTo(loc_x, loc_y);
paintCtx.lineWidth = 5;


function handle(data) {
	if(data.length > 2) {
	  	motion = JSON.parse(data);
	  	var dt = 0.5; // to be sent from device, temporarily hard-coded
	
	  	loc_x += motion.rl * ORIENTATION_FACTOR * RAD;
	  	loc_y += motion.pt* ORIENTATION_FACTOR * RAD;
	  	loc_z += motion.az* ORIENTATION_FACTOR * RAD;

/*
	  	var acc = Math.sqrt(Math.pow(motion.acx, 2) + Math.pow(motion.acy, 2));
		// console.log(motion.acx + ", " + motion.acy);
	  	loc_x += Math.cos(motion.rl) * acc * AMPLITUDE;
	  	loc_y += Math.sin(motion.rl) * acc * AMPLITUDE;
	  	// console.log(motion.rl, " ", Math.sin(motion.rl) * acc, " ", acc);
*/

	  	var spilled = (loc_x < 0 || loc_x > paintCanvas.width || loc_y < 0 || loc_y > paintCanvas.height);
	
	  	loc_x = (loc_x + paintCanvas.width) % paintCanvas.width;
		loc_y = (loc_y + paintCanvas.height) % paintCanvas.height;
	  	loc_z %= 10;
	
	  	brushDiv.style.top = loc_y - brushCanvas.height/2 - 10;
	  	brushDiv.style.left = loc_x - brushCanvas.width/2-30;
		brushCtx.clearRect(0,0,brushCanvas.width,brushCanvas.height);
 		brushCtx.translate(brushCanvas.width/2, brushCanvas.height/2);
		brushCtx.rotate(motion.rl);
		brushCtx.drawImage(brush, 0, 0, 64,64);
		brushCtx.rotate(-motion.rl);
  		brushCtx.translate(-brushCanvas.width/2, -brushCanvas.height/2);
		
	  	//console.log("location-x:",loc_x, ", location-y: ", loc_y, ", location-z: ", loc_z);
	  	if (motion.sp) {
	  		paintCtx.drawImage(splash, loc_x - 35, loc_y - 35);
	  	}
	  	// console.log(loc_x, ", ", loc_y);
	  	if(!spilled && motion.pd) {
	  		paintCtx.lineTo(loc_x, loc_y);
	  		paintCtx.stroke();
  		}
	  	paintCtx.moveTo(loc_x, loc_y);
	}  	
}

function savePaintCanvas() {
	Canvas2Image.saveAsPNG(paintCanvas);  
}

	
	
/*
setInterval(function() {
	socket.emit("orientation", JSON.stringify({
		x: Math.random()*20 - 10,
		y: Math.random()*20 - 10,
		z: Math.random()*20 - 10,
		azimuth : 30,
		pitch: 60,
		roll: 90
	}));
}, 100);
*/

</script> 	

	</body>

</html>