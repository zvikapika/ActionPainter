<!DOCTYPE html5>
<html>
	<head>
		 <meta http-equiv="Pragma" content="no-cache">
		 <meta http-equiv="Cache-Control" content="no-cache">
		 <meta http-equiv="Expires" content="Sat, 01 Dec 2001 00:00:00 GMT">
		<title>Action Painter</title>
		<style>
			body {
				margin: 0;
			}
			#brush {
				-webkit-transition: top 0.1s ease, left 0.1s ease;
				position: absolute;
				width: 64px;
				margin-top: -10px;
				margin-left: -10px;
			}
			#paintCanvas {
				position: absolute;
				top: 0;
				bottom: 0;
				left: 0;
				right: 0;
			}
		</style>
		<script src="static/socket.io.js"></script>
		<script src="static/base64.js"></script>
		<script src="static/canvas2image.js"></script>
	</head>
	<body>
		<canvas id="paintCanvas" width=1410 height=870 style="border:15px solid #d3d3d3;"></canvas> 

		<div id="brushDiv1" style="position:absolute">
			<canvas id="brushCanvas1"></canvas>
 		</div>		
		<div id="brushDiv2" style="position:absolute">
			<canvas id="brushCanvas2"></canvas>
 		</div>		

		<img id="splash" src="static/splash.png" width="100" style="display:none"/>
		<img id="brush1" src="static/brush1.png" width="64" style="display:none"/>
		<img id="brush2" src="static/brush2.png" width="64" style="display:none"/>

		<script type="text/javascript">

var socket = io.connect('/');
	socket.on('orientationupdate', function (data) {
		handle(data);
 	});
 

var brush1Div = document.getElementById("brushDiv1");
var brush2Div = document.getElementById("brushDiv2");
var paintCanvas = document.getElementById("paintCanvas");
var brushCanvas1 = document.getElementById("brushCanvas1");
var brushCanvas2 = document.getElementById("brushCanvas2");
var splash = document.getElementById("splash");
var paintCtx = paintCanvas.getContext("2d");
var brush1Ctx = brushCanvas1.getContext("2d");
var brush2Ctx = brushCanvas2.getContext("2d");

var brush, brushDiv, brushCtx, brushCanvas;
var user = 0;

//canvas.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT);
//canvas.mozRequestFullScreen();
document.body.style.overflow = "hidden"; // disable scrollbars


var loc_x = [paintCanvas.width*1/3, paintCanvas.width*2/3];
var loc_y = [paintCanvas.height/2,paintCanvas.height/2];
var loc_x1 = [0,0], loc_y1 = [0,0], loc_x2 = [0,0], loc_y2 = [0,0];
var MASS_RATIO = 0.1;
var MAX_VELOCITY = 10;
var BRUSH_SPEED = 10;
var ORIENTATION_FACTOR = 0.15;
var XMARGIN = 10;
var YMARGIN = 10;
var RAD = 57.2957795;
var AMPLITUDE = 7;

var paintMode = 3;
var colorCounter = 0;

paintCtx.moveTo(loc_x[user], loc_y[user]);
paintCtx.lineWidth = 7;

function max(a,b) {
 return (a>b ? a : b);
}

function min(a,b) {
 return (a<b ? a : b);
}

function handle(data) {
	if(data.length > 2) {
	  	motion = JSON.parse(data);
		//user
		user = motion.id % 2;
		if (user == 0)
		{
		  brush = brush1;
		  brushDiv = brush1Div;
		  brushCtx = brush1Ctx;
		  brushCanvas = brushCanvas1;
		}
		if (user == 1)
		{
		  brush = brush2;
		  brushDiv = brush2Div;
		  brushCtx = brush2Ctx;
		  brushCanvas = brushCanvas2;
		}
		
		
		// console.log("rl=" + motion.rl + ", pt=" + motion.pt);
	  	loc_x[user] += motion.rl * ORIENTATION_FACTOR * RAD * Math.abs(motion.acx);
//	  	loc_y += motion.pt* ORIENTATION_FACTOR * RAD * Math.abs(motion.acy);

	  	var acc = Math.sqrt(Math.pow(motion.acx, 2) + Math.pow(motion.acy, 2));

		if(Math.abs(motion.rl) < 1.5) {//facing up
			loc_y[user] -= (1.5 - Math.abs(motion.rl)) * ORIENTATION_FACTOR * RAD * acc;
		}
		else {//facing down
			loc_y[user] += (Math.abs(motion.rl) - 1.5) * ORIENTATION_FACTOR * RAD * acc;
		}
				
		switch (motion.cmd)
		{
		 case 'm': 	paintMode = (paintMode+1)%4; //change paint mode
					break;
		 case 'p': 	Canvas2Image.saveAsPNG(paintCanvas); 
					break;
		 case 'c': 	paintCanvas.width = paintCanvas.width; //clear canvas  - lousy hack :( 
					break;
		 case '+': 	{//color change
						++colorCounter;
		 				colorCounter %= 4;
		 				console.log("color set to: " + colorCounter);
					}
					break;

		}
		
	  	var spilled = (loc_x[user] <= XMARGIN || loc_x[user] >= paintCanvas.width-XMARGIN || loc_y[user] <= YMARGIN || loc_y[user] >= paintCanvas.height-YMARGIN);
	    
		//constraint brush to canvas
		if (loc_x[user] < XMARGIN) {
			loc_x[user] = XMARGIN;
			spilled = true;
			}
		if (loc_x[user]>paintCanvas.width-XMARGIN){
			loc_x[user] = paintCanvas.width-XMARGIN;
			spilled = true;
			}
		if (loc_y[user] < YMARGIN){
			loc_y[user] = YMARGIN;
			spilled = true;
			}
		if (loc_y[user]>paintCanvas.height-YMARGIN){
			loc_y[user] = paintCanvas.height-YMARGIN;
			spilled = true;
			}
	

	    //display (rotated) brush
	  	brushDiv.style.top = loc_y[user] - brushCanvas.height/2 - 10;
	  	brushDiv.style.left = loc_x[user] - brushCanvas.width/2-30;
		brushCtx.clearRect(0,0,brushCanvas.width,brushCanvas.height);
 		brushCtx.translate(brushCanvas.width/2, brushCanvas.height/2);
		brushCtx.rotate(motion.rl);
		brushCtx.drawImage(brush, 0, 0, 64,64);
		brushCtx.rotate(-motion.rl);
  		brushCtx.translate(-brushCanvas.width/2, -brushCanvas.height/2);
		
	  	//console.log("location-x:",loc_x, ", location-y: ", loc_y);
	  	if (motion.sp) {
	  		paintCtx.drawImage(splash, loc_x[user] - 35, loc_y[user] - 35);
	  	}
	  	// console.log(loc_x[user], ", ", loc_y[user]);
	  	if(!spilled && motion.pd) {
			paintCtx.beginPath();
			paintCtx.moveTo(loc_x1[user], loc_y1[user]);
		    paintCtx.lineWidth = 2+Math.pow(acc,2);
			paintCtx.globalAlpha = 0.4; // set global alpha
			
			switch (colorCounter)
			{
			 case 0: 
				paintCtx.strokeStyle = "#000000"; // black
			 	break;
			 case 1: 
				paintCtx.strokeStyle = "#00e0ff"; // cyan
			 	break;
			 case 2: 
				paintCtx.strokeStyle = "#ff0080"; // magenta
			 	break;
			 case 3: 
				paintCtx.strokeStyle = "#ffff00"; // yellow
			 	break;
			}
			
			switch (paintMode) {
			 case 0:
				paintCtx.lineCap = "round";
				paintCtx.bezierCurveTo(
					loc_x2[user], loc_y2[user], loc_x1[user], loc_y1[user], loc_x[user], loc_y[user]
				);
				break;
			 case 1:
				paintCtx.lineCap = "butt";
				
				paintCtx.quadraticCurveTo(loc_x1[user],loc_y1[user],loc_x[user],loc_y[user]);
				break;
			 case 2:
				paintCtx.lineCap = "round";
		  		paintCtx.lineTo(loc_x[user], loc_y[user]);
				break;
			 case 3:
				paintCtx.lineCap = "butt";
		  		paintCtx.lineTo(loc_x[user], loc_y[user]);
				break;
			}
	  		paintCtx.stroke();
  		}
	  	
	  	loc_x2[user] = loc_x1[user];
	  	loc_y2[user] = loc_y1[user];
	  	
	  	loc_x1[user] = loc_x[user];
	  	loc_y1[user] = loc_y[user];
	}  	
}

/*	
var counter = 0;
setInterval(function() {
    var x = paintCanvas.width-XMARGIN-150;
    var y = 100;
 
    paintCtx.font = "80pt Calibri";
	if (counter<10)
		paintCtx.fillStyle = "#0000ff"; // text color
	else
		paintCtx.fillStyle = "#FFFFff"; // text color
	
    paintCtx.fillText(counter%10, x, y);	
	counter = (counter+1)%20
	
}, 100);
*/

</script> 	

	</body>

</html>